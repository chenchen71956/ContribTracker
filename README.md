# ContribTracker

一个用于追踪玩家贡献的Minecraft Fabric服务器模组。

## 最新更新

### 2023-06-15

- 修复了SQLite JDBC驱动加载问题：
  - 将驱动类名从`org.sqlite.JDBC`改为`com.example.contribtracker.shadow.org.sqlite.JDBC`
  - 使用shadowJar插件，只打包SQLite驱动而非所有依赖
  - 优化了依赖管理
- 暂时禁用了WebSocket功能以减少依赖
- 完善了命令系统架构
- 实现了多级贡献者权限管理

## 功能特点

- 支持离线玩家贡献记录
- 贡献位置追踪
- 贡献邀请5分钟过期机制
- 多层次贡献者权限管理

## 安装

1. 将模组放入服务器的`mods`文件夹
2. 重启服务器

## 命令使用

### 1. 记录贡献

基本格式：

```a
/contribtracker <类型> <贡献名称> <注释>
```

示例：

```a
/contribtracker 红石 自动农场 建造了自动收割系统
```

### 2. 记录多人贡献

扩展格式：

```a
/contribtracker <类型> <贡献名称> <注释> [<游戏ID1> <注释1>] [<游戏ID2> <注释2>] ...
```

示例：

```a
/contribtracker 建筑 城堡 设计了城堡结构 550e8400-e29b-41d4-a716-446655440001 建造了城墙 550e8400-e29b-41d4-a716-446655440002 装饰了内部
```

### 3. 查看附近贡献

```a
/contribtracker n
```

显示半径32格内的所有贡献，格式：

```a
| 贡献ID | 贡献名 | 创建人 |
```

### 4. 查看所有贡献

```a
/contribtracker list
```

显示所有贡献，格式：

```a
ID | 贡献类型 | 贡献名称 | 创建人 | 坐标
```

所有玩家都可以执行此命令，以查看服务器上的所有贡献记录。

### 5. 删除贡献

```a
/contribtracker delete <贡献ID>
```

注意：

- 管理员可以删除任何贡献
- 一级贡献者只能删除自己创建的贡献
- 二级及以下贡献者不允许删除贡献

### 6. 删除贡献者

```a
/contribtracker remove <贡献ID> <玩家名>
```

注意：

- 管理员可以删除任何贡献者
- 贡献创建者可以删除任何贡献者
- 贡献者只能删除自己邀请的贡献者（即比自己层级低的贡献者）

### 7. 邀请新成员

```a
/contribtracker invite <玩家名> <贡献名称>
```

注意：

- 管理员可以邀请任何人
- 贡献创建者可以邀请任何人
- 贡献者可以邀请新成员，被邀请的成员将成为邀请者的下级
- 邀请有效期为5分钟

### 8. 直接添加贡献者

```a
/contribtracker add <贡献ID> <玩家名> <注释>
```

注意：

- 管理员可以直接添加任何玩家为贡献者
- 贡献创建者可以直接添加任何玩家为贡献者
- 一级贡献者可以直接添加任何玩家为贡献者
- 被添加的玩家将自动成为添加者的下级

## 权限层级

贡献者权限系统采用多层级设计：

1. 管理员（最高权限）
   - 可以删除任何贡献
   - 可以删除任何贡献者
   - 可以邀请任何人
   - 可以直接添加任何玩家为贡献者

2. 贡献创建者
   - 可以删除自己的贡献
   - 可以删除任何贡献者
   - 可以邀请任何人
   - 可以直接添加任何玩家为贡献者

3. 一级贡献者（被创建者直接邀请）
   - 可以邀请新成员
   - 可以直接添加任何玩家为贡献者
   - 只能删除自己邀请的贡献者

4. 二级贡献者（被一级贡献者邀请）
   - 可以邀请新成员
   - 只能删除自己邀请的贡献者

5. 三级及以下贡献者
   - 可以邀请新成员
   - 只能删除自己邀请的贡献者

## WebSocket API

> **注意：在当前版本中，WebSocket功能已被临时禁用以减少依赖。**
> **计划在未来版本中重新启用此功能。如需启用，请在build.gradle中调整依赖配置。**

模组提供了WebSocket接口用于实时获取贡献者信息：

- 连接地址：`ws://localhost:25566/ws`

### 消息格式

所有消息都使用JSON格式，基本结构如下：

```json
{
    "type": "消息类型",
    "data": "消息数据"
}
```

### 消息类型

1. 客户端发送：
   - `check` - 请求获取所有数据

   ```json
   {
       "type": "check"
   }
   ```

   - `pong` - 响应服务器的ping消息

   ```json
   {
       "type": "pong"
   }
   ```

2. 服务器发送：
   - `ping` - 保活消息

   ```json
   {
       "type": "ping"
   }
   ```

   - `all_data` - 所有贡献数据

   ```json
   {
       "type": "all_data",
       "data": [
           {
               "id": 1,
               "name": "贡献名称",
               "type": "贡献类型",
               "creatorUuid": "创建者UUID",
               "creatorName": "创建者名称",
               "x": 0,
               "y": 0,
               "z": 0,
               "world": "世界名称",
               "createdAt": "创建时间",
               "contributorList": [
                   {
                       "playerUuid": "玩家UUID",
                       "playerName": "玩家名称",
                       "level": 1,
                       "inviterUuid": "邀请者UUID",
                       "note": "玩家贡献说明"
                   }
               ]
           }
       ]
   }
   ```

   - `update` - 贡献更新

   ```json
   {
       "type": "update",
       "data": {
           "id": 1,
           "name": "贡献名称",
           "type": "贡献类型",
           "creatorUuid": "创建者UUID",
           "creatorName": "创建者名称",
           "x": 0,
           "y": 0,
           "z": 0,
           "world": "世界名称",
           "createdAt": "创建时间",
           "contributorList": [
               {
                   "playerUuid": "玩家UUID",
                   "playerName": "玩家名称",
                   "level": 1,
                   "inviterUuid": "邀请者UUID",
                   "note": "玩家贡献说明"
               }
           ]
       }
   }
   ```

   - `error` - 错误信息

   ```json
   {
       "type": "error",
       "data": "错误信息"
   }
   ```

### 使用说明

1. 连接WebSocket服务器
2. 连接成功后，服务器会自动发送所有数据
3. 当有贡献更新时，服务器会自动广播更新消息
4. 客户端可以随时发送`check`消息请求获取最新数据

### 保活机制

1. 服务器每30秒向所有客户端发送一次`ping`消息
2. 客户端收到`ping`消息后，必须立即回复`pong`消息
3. 如果服务器在60秒内没有收到客户端的`pong`响应，将自动断开连接
4. 客户端断开连接后，需要重新连接才能继续接收数据

## 数据库

使用SQLite数据库存储数据，数据库文件位于服务器根目录的`contributions.db`。

## 注意事项

1. 贡献创建者自动成为一级贡献者
2. 贡献者可以添加自己的注释说明贡献内容
3. 贡献邀请5分钟后自动过期
4. 贡献者只能管理自己邀请的下级贡献者
5. 每个贡献者都有一个层级值，表示其在贡献中的权限级别
6. 管理员和一级贡献者可以直接添加贡献者，无需邀请流程
